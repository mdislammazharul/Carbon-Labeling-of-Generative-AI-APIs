<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Carbon-Labeling of Generative-AI APIs ‚Äì Study</title>
    <meta name="description" content="Experimental study on carbon labels for AI APIs." />

    <!-- Markdown + code highlighting -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        :root {
            --green: #2e7d32;
            --green-600: #1b5e20;
            --danger: #c62828;
            --danger-100: #fde7e7;
            --danger-700: #b71c1c;
            --text: #1f2937;
            --muted: #6b7280;
            --bg: #f6fbf7;
        }

        * {
            box-sizing: border-box;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text)
        }

        .wrap {
            max-width: 880px;
            margin: 0 auto;
            padding: 24px
        }

        .card {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 6px 24px rgba(0, 0, 0, .06);
            padding: 24px
        }

        h1,
        h2 {
            margin: 0 0 10px
        }

        h1 {
            font-size: 24px
        }

        h2 {
            font-size: 20px;
            color: var(--green-600)
        }

        p {
            line-height: 1.5
        }

        .btn {
            appearance: none;
            border: 0;
            border-radius: 12px;
            padding: 12px 18px;
            font-weight: 600;
            cursor: pointer;
            background: var(--green);
            color: #fff
        }

        .btn:disabled {
            opacity: .5;
            cursor: not-allowed
        }

        .btn.secondary {
            background: #fff;
            color: var(--green);
            border: 2px solid var(--green)
        }

        .btn.danger {
            background: var(--danger)
        }

        .row {
            display: flex;
            gap: 16px;
            flex-wrap: wrap
        }

        .col {
            flex: 1 1 260px
        }

        label {
            font-weight: 600;
            display: block;
            margin: 12px 0 6px
        }

        input[type="text"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 10px;
            background: #fff
        }

        textarea {
            min-height: 120px;
            resize: vertical
        }

        .hidden {
            display: none
        }

        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin: 8px 0 16px
        }

        .stat {
            background: #fff;
            border: 1px solid #e5e7eb;
            padding: 10px 12px;
            border-radius: 12px;
            display: flex;
            gap: 8px;
            align-items: center
        }

        .muted {
            color: var(--muted);
            font-size: 13px
        }

        .footer {
            margin-top: 20px;
            font-size: 12px;
            color: var(--muted)
        }

        .footer a {
            text-decoration: none;
            color: var(--muted)
        }

        /* Carbon meter (RED) */
        .meter {
            height: 14px;
            background: var(--danger-100);
            border-radius: 999px;
            overflow: hidden
        }

        .meter>div {
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, #ff6b6b, var(--danger-700));
            transition: width .3s
        }

        /* Output Markdown box (bigger by default) */
        .output-box {
            min-height: 360px;
            border: 1px solid #d1d5db;
            border-radius: 10px;
            background: #fff;
            padding: 14px;
            overflow: auto;
        }

        .output-box pre {
            background: #f6f8fa;
            padding: 12px;
            border-radius: 8px;
            overflow: auto;
        }

        .output-box code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace
        }
    </style>
</head>

<body>
    <div class="wrap">
        <div class="card">
            <div id="page-consent">
                <h1>üåø Carbon-Labeling of Generative-AI APIs ‚Äî Consent</h1>
                <p>
                    You‚Äôre invited to a 5-minute study about how carbon labels may affect API usage
                    choices.
                    We log your interaction counts and demographics (non-identifying). No IPs or
                    names are collected.
                    Data will be stored in a secured JSON file and deleted after the project
                    finishes.
                </p>
                <ul>
                    <li>Voluntary and anonymous (random participant ID)</li>
                    <li>Can exit anytime ‚Äî we‚Äôll still save progress</li>
                    <li>Estimated duration: ~5 minutes</li>
                </ul>
                <label><input type="checkbox" id="consentCheck"> I have read this information and
                    consent to participate.</label>
                <div class="row">
                    <button class="btn" id="btnConsentNext" disabled>Agree & Continue</button>
                </div>
                <div class="footer">
                    Contact: <a href="mailto:mdmazharul.cc@gmail.com">Md Mazharul Islam</a> ‚Ä¢
                    Purpose: academic research ‚Ä¢ Ethics: minimal risk
                </div>
            </div>

            <div id="page-demo" class="hidden">
                <h1>üìã Demographics</h1>
                <p class="muted">These items are required to continue. We do not collect any
                    personally identifiable information.</p>
                <div class="row">
                    <div class="col">
                        <label>Age</label>
                        <select id="age" required>
                            <option value="">Select‚Ä¶</option>
                            <option>18-24</option>
                            <option>25-34</option>
                            <option>35-44</option>
                            <option>45-54</option>
                            <option>55-64</option>
                            <option>65+</option>
                            <option>Prefer not to say</option>
                        </select>
                    </div>
                    <div class="col">
                        <label>Gender</label>
                        <select id="gender" required>
                            <option value="">Select‚Ä¶</option>
                            <option>Female</option>
                            <option>Male</option>
                            <option>Non-binary</option>
                            <option>Prefer to self-describe</option>
                            <option>Prefer not to say</option>
                        </select>
                    </div>
                    <div class="col">
                        <label>Country</label>
                        <select id="country" required></select>
                    </div>
                    <div class="col">
                        <label>Education</label>
                        <select id="education" required>
                            <option value="">Select‚Ä¶</option>
                            <option>High school or less</option>
                            <option>College</option>
                            <option>Bachelor‚Äôs</option>
                            <option>Master‚Äôs</option>
                            <option>Doctorate</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div class="col">
                        <label>Employment</label>
                        <select id="employment" required>
                            <option value="">Select‚Ä¶</option>
                            <option>Student</option>
                            <option>Employed full-time</option>
                            <option>Employed part-time</option>
                            <option>Self-employed</option>
                            <option>Unemployed</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div class="col">
                        <label>Tech experience</label>
                        <select id="techExp" required>
                            <option value="">Select‚Ä¶</option>
                            <option>Beginner</option>
                            <option>Intermediate</option>
                            <option>Advanced</option>
                        </select>
                    </div>
                    <div class="col">
                        <label>AI use frequency</label>
                        <select id="aiUse" required>
                            <option value="">Select‚Ä¶</option>
                            <option>Several times/day</option>
                            <option>Weekly</option>
                            <option>Monthly</option>
                            <option>Never</option>
                        </select>
                    </div>
                    <div class="col">
                        <label>Environmental concern</label>
                        <select id="envConcern" required>
                            <option value="">Select‚Ä¶</option>
                            <option>Not concerned</option>
                            <option>Slightly concerned</option>
                            <option>Moderately concerned</option>
                            <option>Very concerned</option>
                            <option>Extremely concerned</option>
                        </select>
                    </div>
                </div>
                <div class="row" style="margin-top:12px">
                    <button class="btn" id="btnDemoNext" disabled>Continue to Task</button>
                </div>
            </div>

            <div id="page-task" class="hidden">
                <div class="topbar">
                    <div class="stat"><strong>‚è≥ Time left:</strong>&nbsp;<span
                            id="timer">05:00</span></div>
                    <div class="stat"><strong>üîÑ API calls:</strong>&nbsp;<span
                            id="apiCount">0</span></div>
                </div>

                <h2>Carbon meter</h2>
                <div class="muted" id="carbonHint">Estimated emissions for this session
                    (illustrative only).</div>
                <div class="meter" style="margin:8px 0 6px">
                    <div id="meterFill"></div>
                </div>
                <div><strong id="carbonTotal">0 g CO‚ÇÇ</strong> <span class="muted"
                        id="carbonEq"></span></div>

                <label for="prompt" style="margin-top:16px">Your prompt</label>
                <textarea id="prompt"
                    placeholder="Ask anything‚Ä¶ e.g., ‚ÄòGive me a sci-fi movie.‚Äô"></textarea>

                <div class="row" style="margin-top:10px">
                    <button class="btn" id="btnGenerate">Generate</button>
                    <button class="btn secondary" id="btnExit">Exit</button>
                </div>

                <label style="margin-top:18px">AI output</label>
                <div id="output" class="output-box" aria-live="polite"></div>

                <p class="footer">Designed to be minimalist and energy-light üåø</p>
            </div>

            <div id="page-exit" class="hidden">
                <h1>üåø Thank you for participating</h1>
                <p>Your responses will be saved when you click <strong>Submit</strong> below.</p>
                <hr style="margin:16px 0; opacity:.2">
                <h2>Final question</h2>
                <p><strong>Do you think adding a visible carbon meter to ALL LLM apps is better, so
                        that users avoid purposeless usage?</strong></p>
                <div style="margin:10px 0 16px">
                    <label><input type="radio" name="exitOpinion" value="yes"> Yes</label><br>
                    <label><input type="radio" name="exitOpinion" value="no"> No</label><br>
                    <label><input type="radio" name="exitOpinion" value="unsure"> Not sure</label>
                </div>
                <div class="row">
                    <button class="btn" id="btnExitSubmit">Submit</button>
                </div>
                <p class="footer" style="margin-top:16px">
                    Your data (API counts, carbon estimate, and demographics) will be stored
                    securely and deleted after the study concludes.
                </p>
            </div>

            <div id="page-final" class="hidden">
                <h1>‚úÖ Submitted</h1>
                <p>Thanks again for your time. Your responses have been recorded.</p>
            </div>

        </div>
    </div>

    <script>
        /*** ==== CONFIG ==== ***/
        const WORKER_URL = "https://delicate-bush-6d9c.mazhar-tc.workers.dev/";
        const JSONBIN_URL = "https://api.jsonbin.io/v3/b";
        const JSONBIN_KEY = "$2a$10$.82ABZdcA/tEB4awMrFsX.7eqPzlvYjPHC5km.W381pJT1YL3ihTe";

        // Timer length (seconds) -> 5 minutes
        const TASK_SECONDS = 5 * 60;

        // Carbon display constants (illustrative only)
        const CO2_PER_CALL_GRAMS = 5;
        const CAR_G_PER_KM = 120;
        let carbonDisplayMode = Math.floor(Math.random() * 3);

        /*** ==== STATE ==== ***/
        let participant = {
            id: crypto.randomUUID(),
            consent: false,
            demographics: {},
            startedAt: null,
            endedAt: null,
            apiCalls: [], // {t, promptLen, outputLen}
            apiCount: 0,
            carbonGrams: 0,
            exitOpinionCarbonMeter: null // true/false
        };
        let tRemaining = TASK_SECONDS;
        let timerHandle = null;

        // Markdown config (highlight code blocks)
        marked.setOptions({
            highlight(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            }
        });

        /*** ==== UTIL ==== ***/
        function $(id) { return document.getElementById(id); } // single declaration only
        function show(id) { $(id).classList.remove("hidden"); }
        function hide(id) { $(id).classList.add("hidden"); }
        function fmtTime(s) { const m = Math.floor(s / 60), ss = String(s % 60).padStart(2, "0"); return `${m}:${ss}`; }
        function requireAllFilled(ids) { return ids.every(id => { const el = $(id); return el && el.value && el.value.trim() !== ""; }); }

        function populateCountries() {
            const list = ["", "Afghanistan", "Argentina", "Australia", "Austria", "Bangladesh", "Belgium", "Brazil", "Bulgaria", "Canada", "Chile", "China", "Colombia", "Croatia", "Czechia", "Denmark", "Egypt", "Estonia", "Finland", "France", "Germany", "Greece", "Hong Kong", "Hungary", "India", "Indonesia", "Ireland", "Israel", "Italy", "Japan", "Kenya", "Latvia", "Lithuania", "Malaysia", "Mexico", "Netherlands", "New Zealand", "Nigeria", "Norway", "Pakistan", "Peru", "Philippines", "Poland", "Portugal", "Romania", "Russia", "Saudi Arabia", "Serbia", "Singapore", "Slovakia", "Slovenia", "South Africa", "South Korea", "Spain", "Sweden", "Switzerland", "Taiwan", "Thailand", "Turkey", "Ukraine", "United Arab Emirates", "United Kingdom", "United States", "Vietnam", "Other", "Prefer not to say"];
            const c = $("country");
            c.innerHTML = list.map(x => `<option>${x}</option>`).join("");
            c.firstElementChild.value = "";
        }

        function startTimer() {
            $("timer").textContent = fmtTime(tRemaining);
            timerHandle = setInterval(() => {
                tRemaining--;
                $("timer").textContent = fmtTime(Math.max(0, tRemaining));
                if (tRemaining <= 0) {
                    clearInterval(timerHandle);
                    alert("Time is up‚Äîplease submit your session. Thank you!");
                }
            }, 1000);
        }

        function updateCarbonUI() {
            const grams = participant.carbonGrams;

            if (carbonDisplayMode === 0) {
                // Hide everything related to carbon
                document.querySelector(".meter").style.display = "none";
                $("carbonTotal").style.display = "none";
                $("carbonEq").style.display = "none";
                $("carbonHint").style.display = "none";

                // Hide the "Carbon meter" heading
                document.querySelector("h2").style.display = "none";
                return;
            }

            // Show the heading again for modes 1 & 2
            document.querySelector("h2").style.display = "";
            $("carbonHint").style.display = "";

            $("carbonTotal").style.display = "";
            $("carbonTotal").textContent = `${grams.toFixed(1)} g CO‚ÇÇ`;

            if (carbonDisplayMode === 1) {
                $("carbonEq").style.display = "none";
            } else if (carbonDisplayMode === 2) {
                $("carbonEq").style.display = "";
                $("carbonEq").textContent = `‚âà ${(grams / CAR_G_PER_KM).toFixed(3)} km (car)`;
            }

            document.querySelector(".meter").style.display = "";
            const pct = Math.min(100, (grams / (CO2_PER_CALL_GRAMS * 20)) * 100);
            $("meterFill").style.width = pct + "%";
        }
        async function postToJSONBin(payload) {
            const res = await fetch(JSONBIN_URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-Master-Key": JSONBIN_KEY
                },
                body: JSON.stringify(payload)
            });
            if (!res.ok) {
                const t = await res.text().catch(() => res.statusText);
                throw new Error(`JSONBin error: ${res.status} ${t}`);
            }
            return res.json();
        }

        /*** ==== STREAMING & MARKDOWN RENDER ==== ***/
        function parseSSEFrames(buffer) {
            const parts = buffer.split(/\r?\n\r?\n/);
            const remainder = parts.pop();
            const frames = [];
            for (let chunk of parts) {
                let event = null;
                const dataLines = [];
                for (const line of chunk.split(/\r?\n/)) {
                    if (line.startsWith("event:")) event = line.slice(6).trim();
                    if (line.startsWith("data:")) dataLines.push(line.slice(5).trim());
                }
                if (dataLines.length) frames.push({ event, dataStr: dataLines.join("\n") });
            }
            return { frames, remainder };
        }

        // Throttled live markdown rendering (smooth, not too chatty)
        function createMarkdownRenderer(outputEl) {
            let pending = false;
            return (md) => {
                if (pending) return;
                pending = true;
                requestAnimationFrame(() => {
                    outputEl.innerHTML = marked.parse(md);
                    // highlight.js: only highlight within this output box
                    outputEl.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
                    pending = false;
                });
            };
        }

        function handleEventObject(obj, acc, render) {
            const ev = obj.event || "";
            const d = obj.data || obj;
            const token = d?.token ?? d?.delta ?? d?.content ?? d?.text_delta ?? null;

            if (/delta/i.test(ev)) {
                if (typeof token === "string") {
                    acc.finalText += token;
                    render(acc.finalText);
                } else if (Array.isArray(d?.choices) && d.choices[0]?.delta?.content) {
                    const t = d.choices[0].delta.content;
                    acc.finalText += t;
                    render(acc.finalText);
                }
                return;
            }
            if (/end/i.test(ev)) {
                const final = d?.text ?? d?.message ?? acc.finalText;
                if (final) {
                    acc.finalText = final;
                    render(final);
                }
                acc.ended = true;
            }
        }

        async function generateText(prompt) {
            const outputEl = $("output");
            const render = createMarkdownRenderer(outputEl);
            outputEl.innerHTML = ""; // clear before streaming

            const res = await fetch(WORKER_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    message: prompt,
                    bot_msg_id: "",
                    user_msg_id: "",
                    temperature: 0.7,
                    tools: []
                })
            });
            if (!res.ok || !res.body) throw new Error(`HTTP ${res.status}`);

            const reader = res.body.getReader();
            const decoder = new TextDecoder("utf-8");
            let buffer = "";
            const acc = { finalText: "", ended: false };

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });

                // Try SSE frames first
                const { frames, remainder } = parseSSEFrames(buffer);
                buffer = remainder;

                if (frames.length) {
                    for (const { event, dataStr } of frames) {
                        try {
                            const obj = JSON.parse(dataStr);
                            if (event) obj.event = event;
                            handleEventObject(obj, acc, render);
                        } catch {
                            if (event && /delta/i.test(event)) {
                                acc.finalText += dataStr;
                                render(acc.finalText);
                            }
                            if (event && /end/i.test(event)) {
                                acc.finalText = acc.finalText || dataStr;
                                render(acc.finalText);
                                acc.ended = true;
                            }
                        }
                    }
                    continue;
                }

                // NDJSON fallback
                let nl;
                while ((nl = buffer.indexOf("\n")) !== -1) {
                    const line = buffer.slice(0, nl).trim();
                    buffer = buffer.slice(nl + 1);
                    if (!line) continue;
                    try {
                        const obj = JSON.parse(line);
                        handleEventObject(obj, acc, render);
                    } catch {
                        acc.finalText += line;
                        render(acc.finalText);
                    }
                }
            }
            if (!acc.ended && acc.finalText) render(acc.finalText);
            return acc.finalText;
        }

        /*** ==== SUBMIT ==== ***/
        async function submitAll(earlyExit) {
            participant.endedAt = new Date().toISOString();
            const payload = {
                action: "submit",
                participantId: participant.id,
                consent: participant.consent,
                startedAt: participant.startedAt,
                endedAt: participant.endedAt,
                timeSpentSec: TASK_SECONDS - Math.max(0, tRemaining),
                demographics: participant.demographics,
                apiCount: participant.apiCount,
                carbonGrams: participant.carbonGrams,
                apiCalls: participant.apiCalls,
                exitOpinionCarbonMeter: participant.exitOpinionCarbonMeter // true/false
            };
            await postToJSONBin(payload);
        }

        /*** ==== EVENTS ==== ***/
        window.addEventListener("DOMContentLoaded", () => {
            populateCountries();
            $("btnConsentNext").disabled = true;

            $("consentCheck").addEventListener("change", () => {
                $("btnConsentNext").disabled = !$("consentCheck").checked;
            });

            $("btnConsentNext").addEventListener("click", () => {
                if (!$("consentCheck").checked) { alert("Please consent to continue."); return; }
                participant.consent = true;
                hide("page-consent"); show("page-demo");
            });

            document.querySelectorAll("#page-demo select").forEach(el => {
                el.addEventListener("change", () => {
                    $("btnDemoNext").disabled = !requireAllFilled(["age", "gender", "country", "education", "employment", "techExp", "aiUse", "envConcern"]);
                });
            });

            $("btnDemoNext").addEventListener("click", () => {
                if (!requireAllFilled(["age", "gender", "country", "education", "employment", "techExp", "aiUse", "envConcern"])) {
                    alert("Please complete all fields to continue."); return;
                }
                participant.demographics = {
                    age: $("age").value, gender: $("gender").value, country: $("country").value,
                    education: $("education").value, employment: $("employment").value,
                    techExp: $("techExp").value, aiUse: $("aiUse").value, envConcern: $("envConcern").value
                };
                hide("page-demo"); show("page-task");
                participant.startedAt = new Date().toISOString();
                updateCarbonUI();
                startTimer();
            });

            $("btnGenerate").addEventListener("click", async () => {
                const prompt = $("prompt").value.trim();
                if (!prompt) { alert("Enter a prompt first."); return; }
                $("btnGenerate").disabled = true;

                $("prompt").value = "";
                $("prompt").placeholder = "Enter your next prompt‚Ä¶";

                try {
                    const out = await generateText(prompt);

                    // Track stats
                    participant.apiCount += 1;
                    $("apiCount").textContent = participant.apiCount;
                    participant.apiCalls.push({
                        t: new Date().toISOString(),
                        promptLen: prompt.length,
                        outputLen: out.length
                    });

                    // New: random carbon increment (0.2 to 1.5 g)
                    const randomIncrement = 0.2 + Math.random() * (1.5 - 0.2);
                    participant.carbonGrams += randomIncrement;

                    updateCarbonUI();
                } catch (e) {
                    console.error(e);
                    $("output").innerHTML = "<em>Generation failed. Please try again.</em>";
                } finally {
                    $("btnGenerate").disabled = false;
                }
            });

            // Exit now routes to the new page (no confirm dialog)
            $("btnExit").addEventListener("click", () => {
                hide("page-task");
                show("page-exit");
            });

            // Final submit from the exit page (no JS alert popups)
            $("btnExitSubmit").addEventListener("click", async () => {
                const sel = document.querySelector('input[name="exitOpinion"]:checked');
                // store as boolean like before: yes => true, no/unsure => false (or keep null if none selected)
                participant.exitOpinionCarbonMeter = sel ? (sel.value === "yes") : null;

                try {
                    await submitAll(tRemaining > 0);
                    hide("page-exit");
                    show("page-final");
                } catch (e) {
                    console.error(e);
                    // No alert modal; inline fallback:
                    const exitPage = $("page-exit");
                    const warn = document.createElement("p");
                    warn.className = "muted";
                    warn.style.color = "#b71c1c";
                    warn.textContent = "We couldn‚Äôt submit right now. Please check your network and press Submit again.";
                    exitPage.appendChild(warn);
                }
            });
        });
    </script>
</body>

</html>